name: ADK Version Monitor

on:
  schedule:
    # Run every 12 hours (midnight and noon UTC)
    - cron: '0 0,12 * * *'
  workflow_dispatch:  # Allow manual triggers
    inputs:
      force_check:
        description: 'Force check even if version unchanged'
        required: false
        default: 'false'

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For committing version file
      issues: write    # For creating issues

    outputs:
      new_version_available: ${{ steps.check_version.outputs.new_version_available }}
      latest_version: ${{ steps.check_version.outputs.latest_version }}
      parent_issue_number: ${{ steps.create_parent_issue.outputs.issue_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check latest ADK version on PyPI
        id: check_version
        run: |
          # Fetch latest version from PyPI
          LATEST_VERSION=$(curl -s https://pypi.org/pypi/google-adk/json | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
          echo "Latest PyPI version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          # Read current tracked version
          if [ -f .github/current_adk_version.txt ]; then
            CURRENT_VERSION=$(cat .github/current_adk_version.txt)
          else
            CURRENT_VERSION="0.0.0"
          fi
          echo "Current tracked version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Compare versions
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ] || [ "${{ github.event.inputs.force_check }}" == "true" ]; then
            echo "new_version_available=true" >> $GITHUB_OUTPUT
            echo "New version detected or forced: $LATEST_VERSION"
          else
            echo "new_version_available=false" >> $GITHUB_OUTPUT
            echo "No new version available"
          fi

      - name: Create parent issue for compatibility review
        if: steps.check_version.outputs.new_version_available == 'true'
        id: create_parent_issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.check_version.outputs.latest_version }}';
            const timestamp = new Date().toISOString();

            const body = `## ADK Version ${version} Released

            A new version of the Google Agent Development Kit has been released. This issue tracks the documentation compatibility review process.

            ### Version Information
            - **ADK Version**: ${version}
            - **Detection Date**: ${timestamp}
            - **PyPI Package**: [google-adk==${version}](https://pypi.org/project/google-adk/${version}/)

            ### Review Process

            This parent issue tracks the overall compatibility review. Sub-issues will be created for each documentation part and the demo application:

            **Documentation:**
            - [ ] Part 1: Introduction to ADK Bidi-streaming
            - [ ] Part 2: Unified Message Processing with LiveRequestQueue
            - [ ] Part 3: Event Handling with run_live()
            - [ ] Part 4: RunConfig Configuration
            - [ ] Part 5: Audio and Video Features
            - [ ] Comprehensive Review: All documentation vs ADK release notes

            **Demo Application:**
            - [ ] Bidi-streaming Demo App (src/bidi-demo)

            ### Automated Reviews

            Each documentation part and the demo application will be reviewed by the **adk-reviewer** agent to identify:
            - API changes that affect the documentation
            - Code examples that need updates
            - New features to document
            - Deprecated functionality to remove

            ### Next Steps

            1. Sub-issues will be automatically created for each documentation part and the demo application
            2. Claude Code will review each using the **adk-reviewer** agent
            3. Review results will be posted as comments on sub-issues
            4. Manual review and updates will be performed as needed

            ---
            *This issue was automatically created by the ADK Version Monitor workflow.*
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ADK v${version} - Documentation Compatibility Review`,
              body: body,
              labels: ['adk-version-update', 'documentation', 'automated']
            });

            console.log(`Created parent issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

      - name: Update version tracking file
        if: steps.check_version.outputs.new_version_available == 'true'
        run: |
          mkdir -p .github
          echo "${{ steps.check_version.outputs.latest_version }}" > .github/current_adk_version.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/current_adk_version.txt

          # Only commit and push if there are changes
          if ! git diff --quiet --staged; then
            git commit -m "chore: update tracked ADK version to ${{ steps.check_version.outputs.latest_version }}"
            git push
          else
            echo "No changes to commit (version file already up to date)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ADK Version Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest PyPI Version**: ${{ steps.check_version.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Tracked Version**: ${{ steps.check_version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Version Available**: ${{ steps.check_version.outputs.new_version_available }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_version.outputs.new_version_available }}" == "true" ]; then
            echo "**Parent Issue Created**: #${{ steps.create_parent_issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          fi

  create-sub-issues:
    needs: check-version
    if: needs.check-version.outputs.new_version_available == 'true'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    strategy:
      matrix:
        part:
          - { number: 1, title: "Introduction to ADK Bidi-streaming", file: "part1_intro.md", type: "documentation" }
          - { number: 2, title: "Unified Message Processing with LiveRequestQueue", file: "part2_live_request_queue.md", type: "documentation" }
          - { number: 3, title: "Event Handling with run_live()", file: "part3_run_live.md", type: "documentation" }
          - { number: 4, title: "RunConfig Configuration", file: "part4_run_config.md", type: "documentation" }
          - { number: 5, title: "Audio and Video Features", file: "part5_audio_and_video.md", type: "documentation" }
          - { number: 6, title: "Bidi-streaming Demo Application", file: "src/bidi-demo", type: "code" }
          - { number: 7, title: "Comprehensive Documentation Review", file: "docs/", type: "comprehensive-review" }

    steps:
      - name: Create sub-issue for ${{ matrix.part.type == 'code' && 'Code' || 'Part' }} ${{ matrix.part.number }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.APP_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ needs.check-version.outputs.latest_version }}';
            const parentIssue = '${{ needs.check-version.outputs.parent_issue_number }}';
            const partNumber = ${{ matrix.part.number }};
            const partTitle = '${{ matrix.part.title }}';
            const partFile = '${{ matrix.part.file }}';
            const partType = '${{ matrix.part.type }}';

            const isCode = partType === 'code';
            const isComprehensive = partType === 'comprehensive-review';
            const reviewType = isCode ? 'Code' : (isComprehensive ? 'Comprehensive Documentation' : 'Documentation');
            const filePath = isCode ? partFile : (isComprehensive ? partFile : `docs/${partFile}`);

            let body;
            if (isComprehensive) {
              body = `## Comprehensive Documentation Review Request

            Please perform a comprehensive review of **all documentation** against ADK v${version} to identify inconsistencies and missing features.

            ### Documentation to Review
            - **All files in ${filePath}** (part1_intro.md through part5_audio_and_video.md)

            ### Review Instructions

            @claude Please use the **comprehensive-reviewer** agent to perform a comprehensive cross-documentation review:

            1. **Use Comprehensive-Reviewer Agent**:
               - The comprehensive-reviewer agent will automatically access ADK v${version} source code
               - It will systematically review all documentation parts and demo code
               - It follows the same successful pattern as individual part reviews

            2. **Comprehensive Analysis**:
               - Read all documentation files in ${filePath}
               - Examine demo application in src/bidi-demo/ for implementation patterns
               - Cross-reference all parts for consistency and coverage

            3. **Identify Cross-Documentation Issues**:
               - **Missing features**: New ADK features not documented anywhere
               - **Cross-part inconsistencies**: Conflicting information between parts
               - **Outdated information**: Documentation describing deprecated behavior
               - **Incomplete coverage**: Features mentioned but not fully explained
               - **Version mismatches**: Examples not compatible with ADK v${version}

            4. **Generate Structured Report**:
               - **Critical issues (C1, C2...)**: Breaking changes not documented
               - **Warnings (W1, W2...)**: New major features missing from docs
               - **Suggestions (S1, S2...)**: Terminology or style improvements

            5. **Provide Comprehensive Findings**:
               - Executive summary of documentation health
               - Cross-documentation consistency analysis
               - Specific recommendations for each identified issue

            ### Related Issues
            - Parent issue: #${parentIssue}

            ---
            *This sub-issue was automatically created by the ADK Version Monitor workflow.*
            *It will be automatically assigned to Claude Code for processing.*
            `;
            } else {
              body = `## ${reviewType} Review Request

            Please review **${isCode ? partTitle : `Part ${partNumber}: ${partTitle}`}** for compatibility with ADK v${version}.

            ### ${isCode ? 'Directory' : 'File'} to Review
            - **${filePath}**

            ### Review Instructions

            @claude Please use the **adk-reviewer** agent to perform a comprehensive review of this ${reviewType.toLowerCase()}:

            1. Read the ${isCode ? 'application code in' : 'file'} **${filePath}**
            2. Use the **adk-reviewer** agent to analyze the content for ADK v${version} compatibility
            3. Identify any:
               - API changes affecting the ${reviewType.toLowerCase()}
               - Code ${isCode ? 'that needs updates' : 'examples that need updates'}
               - Deprecated functionality to remove or update
               - ${isCode ? 'Missing error handling or edge cases' : 'New features to document'}
               - ${isCode ? 'Performance or security issues' : 'Terminology or concept changes'}
            4. Post your findings as a comment on this issue

            ### Related Issues
            - Parent issue: #${parentIssue}

            ---
            *This sub-issue was automatically created by the ADK Version Monitor workflow.*
            *It will be automatically assigned to Claude Code for processing.*
            `;
            }

            const labels = ['adk-version-update', 'automated', `part-${partNumber}`];
            if (isComprehensive) {
              labels.push('comprehensive-review');
              labels.push('documentation');
            } else if (!isCode) {
              labels.push('documentation');
            } else {
              labels.push('demo-app');
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ADK v${version} - Review ${isCode ? '' : `Part ${partNumber}: `}${partTitle}`,
              body: body,
              labels: labels,
              assignees: []
            });

            console.log(`Created sub-issue #${issue.data.number} for ${isComprehensive ? 'Comprehensive Review' : (isCode ? 'Demo App' : `Part ${partNumber}`)}`);

            // Comment on parent issue with link to sub-issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssue,
              body: `Sub-issue created for ${isComprehensive ? 'Comprehensive Review' : (isCode ? 'Demo App' : `Part ${partNumber}`)}: #${issue.data.number}`
            });
